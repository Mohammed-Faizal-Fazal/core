<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="fragments/head :: common-head('Submitted Orders')"></head>

<body class="bg-gray-50">
<div th:replace="fragments/navigation :: navbar"></div>

<div class="container mx-auto px-4 py-8">
  <div class="mb-6 flex justify-between items-center">
    <div>
      <h2 class="text-3xl font-bold text-gray-800">
        <i class="bi bi-check-circle"></i> Submitted Orders
      </h2>
      <p class="text-gray-600">Assign orders to carpenters and generate routes</p>
    </div>
    <button id="assignBtn"
            onclick="openAssignModal()"
            disabled
            class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed">
      <i class="bi bi-person-plus"></i> Assign to Carpenter (<span id="selectedCount">0</span>)
    </button>
  </div>

  <!-- Orders Table -->
  <div class="bg-white rounded-xl shadow-md overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full" id="ordersTable">
        <thead class="gradient-bg text-white">
        <tr>
          <th class="px-4 py-3 text-left">
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="w-4 h-4">
          </th>
          <th class="px-4 py-3 text-left">Order No</th>
          <th class="px-4 py-3 text-left">Customer</th>
          <th class="px-4 py-3 text-left">Phone</th>
          <th class="px-4 py-3 text-left">Address</th>
          <th class="px-4 py-3 text-left">Pincode</th>
          <th class="px-4 py-3 text-left">City</th>
          <th class="px-4 py-3 text-left">Date</th>
          <th class="px-4 py-3 text-left">Status</th>
          <th class="px-4 py-3 text-left">Actions</th>
        </tr>
        </thead>
        <tbody id="ordersTableBody" class="divide-y divide-gray-200">
        <tr>
          <td colspan="10" class="px-4 py-8 text-center text-gray-500">
            <i class="bi bi-hourglass-split text-3xl"></i>
            <p class="mt-2">Loading orders...</p>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Assignment Modal -->
<div id="assignModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold text-gray-800">
        <i class="bi bi-person-workspace"></i> Assign Orders to Carpenter
      </h3>
      <button onclick="closeAssignModal()" class="text-gray-500 hover:text-gray-700">
        <i class="bi bi-x-lg text-2xl"></i>
      </button>
    </div>

    <form id="assignmentForm">
      <!-- Selected Orders Summary -->
      <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
        <p class="font-semibold text-blue-800">
          <i class="bi bi-list-check"></i> Selected Orders: <span id="modalSelectedCount">0</span>
        </p>
        <div id="selectedOrdersList" class="mt-2 text-sm text-blue-700"></div>
      </div>

      <!-- Carpenter Selection -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Select Carpenter *</label>
        <select id="carpenterSelect"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                required
                onchange="onCarpenterChange()">
          <option value="">Loading carpenters...</option>
        </select>
      </div>

      <!-- Carpenter Pincode Input -->
      <div id="carpenterPincodeSection" class="mb-4 hidden">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Carpenter Start Location (Pincode) *
          <span class="text-xs text-gray-500 font-normal ml-2">
                        <i class="bi bi-pencil"></i> Pre-filled with default, you can override
                    </span>
        </label>
        <input type="text" id="carpenterPincode"
               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
               placeholder="Enter carpenter's pincode"
               pattern="[0-9]{6}" maxlength="6" required>
        <small class="text-xs text-gray-500">
          <i class="bi bi-info-circle"></i> Used as starting point for route optimization
        </small>
      </div>

      <!-- Assignment Date -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Assignment Date *</label>
        <input type="date" id="assignmentDate"
               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
               required>
      </div>

      <!-- Auto-Route Option -->
      <div class="mb-6">
        <label class="flex items-center">
          <input type="checkbox" id="autoGenerateRoute" checked class="w-4 h-4 text-green-600 rounded">
          <span class="ml-2 text-sm text-gray-700">
                        <i class="bi bi-map"></i> Automatically generate optimized route after assignment
                    </span>
        </label>
      </div>

      <!-- Action Buttons -->
      <div class="flex space-x-4">
        <button type="submit"
                class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-semibold">
          <i class="bi bi-check-circle"></i> Assign Orders
        </button>
        <button type="button"
                onclick="closeAssignModal()"
                class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition font-semibold">
          <i class="bi bi-x-circle"></i> Cancel
        </button>
      </div>
    </form>

    <!-- Route Generation Status -->
    <div id="routeGenerationStatus" class="hidden mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
      <div class="flex items-center">
        <i class="bi bi-hourglass-split text-blue-600 animate-spin text-xl mr-3"></i>
        <p class="text-blue-800 font-semibold">Generating optimized route...</p>
      </div>
    </div>
  </div>
</div>

<!-- Geocode Fix Modal -->
<div id="geocodeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800">
        <i class="bi bi-geo-alt"></i> Fix Location
      </h3>
      <button onclick="closeGeocodeModal()" class="text-gray-500 hover:text-gray-700">
        <i class="bi bi-x-lg text-xl"></i>
      </button>
    </div>

    <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
      <div class="flex items-start">
        <i class="bi bi-exclamation-triangle text-yellow-600 text-xl mr-3 mt-1"></i>
        <div>
          <p class="text-yellow-800 font-semibold">Unable to automatically locate this address</p>
          <p class="text-yellow-700 text-sm mt-1">Fix using any option below:</p>
        </div>
      </div>
    </div>

    <form id="geocodeForm">
      <input type="hidden" id="geocodeBookingId">

      <div class="mb-6 p-4 bg-gray-50 rounded-lg">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          <i class="bi bi-geo"></i> Current Address
        </label>
        <p id="currentAddress" class="text-gray-800 text-sm"></p>
      </div>

      <!-- Option 1 -->
      <div class="mb-6 border border-gray-200 rounded-lg p-4">
        <div class="flex items-center mb-3">
          <input type="radio" id="optionEditAddress" name="fixOption" value="edit"
                 class="w-4 h-4 text-green-600" checked>
          <label for="optionEditAddress" class="ml-2 text-sm font-semibold text-gray-800 cursor-pointer">
            <i class="bi bi-pencil"></i> Option 1: Edit Address
          </label>
        </div>
        <textarea id="editedAddress" rows="3"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm"
                  placeholder="Edit address (include City, Pincode)"></textarea>
        <small class="text-xs text-gray-500 mt-1 block">
          <i class="bi bi-info-circle"></i> Ensure pincode exists like "... - 560001"
        </small>
      </div>

      <!-- Option 2 -->
      <div class="mb-6 border border-gray-200 rounded-lg p-4">
        <div class="flex items-center mb-3">
          <input type="radio" id="optionManualPincode" name="fixOption" value="pincode"
                 class="w-4 h-4 text-green-600">
          <label for="optionManualPincode" class="ml-2 text-sm font-semibold text-gray-800 cursor-pointer">
            <i class="bi bi-hash"></i> Option 2: Enter Pincode
          </label>
        </div>
        <div id="pincodeSection" class="hidden">
          <input type="text" id="manualPincode"
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                 placeholder="Enter 6-digit pincode"
                 pattern="[0-9]{6}" maxlength="6">
        </div>
      </div>

      <!-- Option 3 -->
      <div class="mb-6 border border-gray-200 rounded-lg p-4">
        <div class="flex items-center mb-3">
          <input type="radio" id="optionMapPicker" name="fixOption" value="map"
                 class="w-4 h-4 text-green-600">
          <label for="optionMapPicker" class="ml-2 text-sm font-semibold text-gray-800 cursor-pointer">
            <i class="bi bi-map"></i> Option 3: Pick from Map
          </label>
        </div>
        <div id="mapPickerSection" class="hidden">
          <div id="mapContainer" class="w-full h-64 rounded-lg border border-gray-300 mb-2"></div>
          <div class="grid grid-cols-2 gap-2 text-xs">
            <div class="p-2 bg-blue-50 rounded">
              <span class="font-semibold text-blue-700">Latitude:</span>
              <span id="selectedLat" class="text-blue-900">-</span>
            </div>
            <div class="p-2 bg-blue-50 rounded">
              <span class="font-semibold text-blue-700">Longitude:</span>
              <span id="selectedLng" class="text-blue-900">-</span>
            </div>
          </div>
          <small class="text-xs text-gray-500 mt-2 block">
            <i class="bi bi-cursor"></i> Click map to select location
          </small>
        </div>
      </div>

      <div class="flex space-x-4">
        <button type="submit"
                class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-semibold">
          <i class="bi bi-check-circle"></i> Update Location
        </button>
        <button type="button"
                onclick="closeGeocodeModal()"
                class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition font-semibold">
          <i class="bi bi-x-circle"></i> Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Google Maps (Best practice: async + callback). Put your key from model/controller if possible -->
<script async defer
        th:src="'https://maps.googleapis.com/maps/api/js?key=' + ${googleMapsApiKey} + '&libraries=places&callback=onGoogleMapsLoaded'">
</script>

<script th:inline="javascript">
  /*<![CDATA[*/
      // NOTE: axios + Swal helpers come from fragments/head.html

      let orders = [];
      let carpenters = [];
      let selectedOrders = new Set();

      let map;
      let marker;
      let selectedLocation = null;
      let failedGeocodeOrders = [];

      let lastAssignmentContext = {
          carpenterId: null,
          routeDate: null,
          startPincode: null
      };

      document.addEventListener('DOMContentLoaded', function () {
          loadOrders();
          loadCarpenters();
          setMinDate();
          setupModalOptionListeners();

          // Form submit handlers
          document.getElementById('assignmentForm').addEventListener('submit', onAssignSubmit);
          document.getElementById('geocodeForm').addEventListener('submit', onGeocodeSubmit);
      });

      // Called by Google Maps API callback
      function onGoogleMapsLoaded() {
          // No-op: map will be created only when user opens map section
          // This avoids "google is undefined" timing issues.
          console.log("Google Maps loaded");
      }

      function setupModalOptionListeners() {
          document.querySelectorAll('input[name="fixOption"]').forEach(radio => {
              radio.addEventListener('change', function () {
                  document.getElementById('pincodeSection').classList.add('hidden');
                  document.getElementById('mapPickerSection').classList.add('hidden');

                  if (this.value === 'pincode') {
                      document.getElementById('pincodeSection').classList.remove('hidden');
                  } else if (this.value === 'map') {
                      document.getElementById('mapPickerSection').classList.remove('hidden');
                      initializeMap();
                  }
              });
          });
      }

      function initializeMap() {
          if (map) return;
          if (!window.google || !google.maps) {
              showError("Google Maps not loaded yet. Please refresh and try again.");
              return;
          }

          const defaultLocation = { lat: 20.5937, lng: 78.9629 };

          map = new google.maps.Map(document.getElementById('mapContainer'), {
              zoom: 5,
              center: defaultLocation,
              mapTypeControl: false
          });

          marker = new google.maps.Marker({
              map: map,
              draggable: true,
              visible: false,
              animation: google.maps.Animation.DROP
          });

          map.addListener('click', function (event) {
              placeMarker(event.latLng);
          });

          marker.addListener('dragend', function (event) {
              updateSelectedLocation(event.latLng);
          });

          const currentAddr = document.getElementById('currentAddress').textContent;
          if (currentAddr && currentAddr !== '-') {
              const geocoder = new google.maps.Geocoder();
              geocoder.geocode({ address: currentAddr }, function (results, status) {
                  if (status === 'OK' && results[0]) {
                      map.setCenter(results[0].geometry.location);
                      map.setZoom(15);
                      placeMarker(results[0].geometry.location);
                  }
              });
          }
      }

      function placeMarker(location) {
          marker.setPosition(location);
          marker.setVisible(true);
          map.panTo(location);
          updateSelectedLocation(location);
      }

      function updateSelectedLocation(location) {
          selectedLocation = { lat: location.lat(), lng: location.lng() };
          document.getElementById('selectedLat').textContent = selectedLocation.lat.toFixed(6);
          document.getElementById('selectedLng').textContent = selectedLocation.lng.toFixed(6);
      }

      function setMinDate() {
          const today = new Date().toISOString().split('T')[0];
          const el = document.getElementById('assignmentDate');
          el.setAttribute('min', today);
          el.value = today;
      }

      async function loadOrders() {
          try {
              const response = await axios.get('/api/bookings/submitted');
              orders = response.data || [];
              renderOrders();
          } catch (error) {
              console.error('Error loading orders:', error);
              showError('Error loading orders: ' + (error.response?.data?.message || error.message));
          }
      }

      async function loadCarpenters() {
          try {
              const response = await axios.get('/api/carpenters/active');
              carpenters = response.data || [];
              populateCarpenterDropdown();
          } catch (error) {
              console.error('Error loading carpenters:', error);
              showError('Error loading carpenters: ' + (error.response?.data?.message || error.message));
          }
      }

      function populateCarpenterDropdown() {
          const select = document.getElementById('carpenterSelect');
          select.innerHTML = '<option value="">Select Carpenter</option>';

          carpenters.forEach(carpenter => {
              const option = document.createElement('option');
              option.value = carpenter.carpenterId;
              option.textContent = `${carpenter.carpenterId} - ${carpenter.carpenterName}`;
              option.dataset.pincode = carpenter.pincode || '';
              select.appendChild(option);
          });
      }

      function onCarpenterChange() {
          const select = document.getElementById('carpenterSelect');
          const selectedOption = select.options[select.selectedIndex];
          const pincodeSection = document.getElementById('carpenterPincodeSection');
          const pincodeInput = document.getElementById('carpenterPincode');

          if (select.value) {
              pincodeSection.classList.remove('hidden');
              const carpenterPincode = selectedOption.dataset.pincode;

              if (carpenterPincode && carpenterPincode !== 'null' && carpenterPincode !== '') {
                  pincodeInput.value = carpenterPincode;
              } else {
                  pincodeInput.value = '';
              }
          } else {
              pincodeSection.classList.add('hidden');
              pincodeInput.value = '';
          }
      }

      function renderOrders() {
          const tbody = document.getElementById('ordersTableBody');

          if (!orders || orders.length === 0) {
              tbody.innerHTML = `
                  <tr>
                      <td colspan="10" class="px-4 py-8 text-center text-gray-500">
                          <i class="bi bi-inbox text-3xl"></i>
                          <p class="mt-2">No submitted orders found</p>
                      </td>
                  </tr>
              `;
              return;
          }

          tbody.innerHTML = orders.map(order => {
              const pincode = extractPincodeFromAddress(order.address);
              const city = extractCityFromAddress(order.address);

              const isSelected = selectedOrders.has(order.id);

              return `
                  <tr class="hover:bg-gray-50 ${isSelected ? 'bg-green-50' : ''}">
                      <td class="px-4 py-3">
                          <input type="checkbox" class="order-checkbox w-4 h-4"
                                 value="${order.id}"
                                 ${isSelected ? 'checked' : ''}
                                 onchange="toggleOrderSelection(${order.id})">
                      </td>
                      <td class="px-4 py-3 font-bold text-green-600">${order.orderNo || 'N/A'}</td>
                      <td class="px-4 py-3">${order.customerName || 'N/A'}</td>
                      <td class="px-4 py-3">${order.customerMobile || 'N/A'}</td>
                      <td class="px-4 py-3 max-w-xs truncate" title="${order.address || 'N/A'}">
                          ${order.address || 'N/A'}
                      </td>
                      <td class="px-4 py-3"><span class="font-semibold text-blue-600">${pincode || 'N/A'}</span></td>
                      <td class="px-4 py-3">${city || 'N/A'}</td>
                      <td class="px-4 py-3">${formatDate(order.createdAt)}</td>
                      <td class="px-4 py-3">
                          <span class="px-3 py-1 rounded-full text-xs font-semibold bg-orange-100 text-orange-800">
                              ${order.assignmentStatus || 'SUBMITTED'}
                          </span>
                      </td>
                      <td class="px-4 py-3">
                          <button onclick="viewOrderDetails(${order.id})"
                                  class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 transition text-sm">
                              <i class="bi bi-eye"></i> View
                          </button>
                      </td>
                  </tr>
              `;
          }).join('');
      }

      function extractPincodeFromAddress(address) {
          if (!address) return null;
          const lastDashIndex = address.lastIndexOf('-');
          if (lastDashIndex === -1) return null;
          const afterDash = address.substring(lastDashIndex + 1).trim();
          if (/^[0-9]{6}$/.test(afterDash)) return afterDash;
          return null;
      }

      function extractCityFromAddress(address) {
          if (!address) return 'Unknown';
          const lastDashIndex = address.lastIndexOf('-');
          if (lastDashIndex === -1) return 'Unknown';
          const addressPart = address.substring(0, lastDashIndex).trim();
          const parts = addressPart.split(',');
          if (parts.length >= 2) return parts[parts.length - 1].trim();
          return 'Unknown';
      }

      function toggleSelectAll() {
          const selectAll = document.getElementById('selectAll');
          const checkboxes = document.querySelectorAll('.order-checkbox');

          if (selectAll.checked) {
              checkboxes.forEach(cb => {
                  cb.checked = true;
                  selectedOrders.add(parseInt(cb.value));
              });
          } else {
              checkboxes.forEach(cb => cb.checked = false);
              selectedOrders.clear();
          }

          updateSelectionUI();
          renderOrders();
      }

      function toggleOrderSelection(orderId) {
          if (selectedOrders.has(orderId)) selectedOrders.delete(orderId);
          else selectedOrders.add(orderId);

          updateSelectionUI();
          renderOrders();
      }

      function updateSelectionUI() {
          const count = selectedOrders.size;
          document.getElementById('selectedCount').textContent = count;
          document.getElementById('assignBtn').disabled = count === 0;

          const selectAll = document.getElementById('selectAll');
          const checkboxes = document.querySelectorAll('.order-checkbox');
          selectAll.checked = checkboxes.length > 0 && count === checkboxes.length;
      }

      function openAssignModal() {
          if (selectedOrders.size === 0) return;

          document.getElementById('modalSelectedCount').textContent = selectedOrders.size;

          const selectedOrderNumbers = Array.from(selectedOrders)
              .map(id => orders.find(o => o.id === id)?.orderNo || id)
              .join(', ');

          document.getElementById('selectedOrdersList').textContent = selectedOrderNumbers;
          document.getElementById('assignModal').classList.remove('hidden');
      }

      function closeAssignModal() {
          document.getElementById('assignModal').classList.add('hidden');
          document.getElementById('assignmentForm').reset();
          document.getElementById('carpenterPincodeSection').classList.add('hidden');
          document.getElementById('routeGenerationStatus').classList.add('hidden');
          setMinDate();
      }

      async function onAssignSubmit(e) {
          e.preventDefault();

          const carpenterId = document.getElementById('carpenterSelect').value;
          const carpenterPincode = document.getElementById('carpenterPincode').value;
          const assignmentDate = document.getElementById('assignmentDate').value;
          const autoRoute = document.getElementById('autoGenerateRoute').checked;

          if (!carpenterId || !carpenterPincode || !assignmentDate) {
              showError('Please fill all required fields');
              return;
          }
          if (!/^[0-9]{6}$/.test(carpenterPincode)) {
              showError('Please enter a valid 6-digit pincode');
              return;
          }

          try {
              const assignResponse = await axios.post('/api/carpenter-assignment/assign', {
                  bookingIds: Array.from(selectedOrders),
                  carpenterId: carpenterId,
                  assignedDate: assignmentDate
              });

              if (assignResponse.data && assignResponse.data.success) {
                  showSuccess(assignResponse.data.message || 'Orders assigned successfully');

                  if (autoRoute) {
                      document.getElementById('routeGenerationStatus').classList.remove('hidden');
                      lastAssignmentContext = { carpenterId, routeDate: assignmentDate, startPincode: carpenterPincode };

                      const routeResponse = await axios.post('/api/carpenter-assignment/generate-route', {
                          carpenterId: carpenterId,
                          routeDate: assignmentDate,
                          startPincode: carpenterPincode
                      });

                      if (routeResponse.data && routeResponse.data.success) {
                          showSuccess('Route optimized successfully! ' + (routeResponse.data.message || ''));
                      } else {
                          if (routeResponse.data?.failedBookings?.length > 0) {
                              failedGeocodeOrders = routeResponse.data.failedBookings;
                              processFailedGeocodes();
                              // don't close modal until flow completes
                              return;
                          } else {
                              showWarning('Orders assigned but route optimization failed: ' + (routeResponse.data?.message || 'Unknown'));
                          }
                      }
                  }

                  selectedOrders.clear();
                  updateSelectionUI();
                  closeAssignModal();
                  loadOrders();
              } else {
                  showError(assignResponse.data?.message || 'Assignment failed');
              }
          } catch (error) {
              console.error('Error assigning orders:', error);
              showError('Error assigning orders: ' + (error.response?.data?.message || error.message));
          }
      }

      function processFailedGeocodes() {
          if (failedGeocodeOrders.length > 0) {
              const first = failedGeocodeOrders[0];
              openGeocodeModal(first.id, first.address);
          }
      }

      function openGeocodeModal(bookingId, address) {
          document.getElementById('geocodeBookingId').value = bookingId;
          document.getElementById('currentAddress').textContent = address || '-';
          document.getElementById('editedAddress').value = address || '';
          document.getElementById('manualPincode').value = '';

          document.getElementById('optionEditAddress').checked = true;
          document.getElementById('pincodeSection').classList.add('hidden');
          document.getElementById('mapPickerSection').classList.add('hidden');

          selectedLocation = null;
          document.getElementById('selectedLat').textContent = '-';
          document.getElementById('selectedLng').textContent = '-';

          document.getElementById('geocodeModal').classList.remove('hidden');
      }

      function closeGeocodeModal() {
          document.getElementById('geocodeModal').classList.add('hidden');
          document.getElementById('geocodeForm').reset();
      }

      async function onGeocodeSubmit(e) {
          e.preventDefault();

          const bookingId = document.getElementById('geocodeBookingId').value;
          const selectedOption = document.querySelector('input[name="fixOption"]:checked').value;

          try {
              let response;

              if (selectedOption === 'edit') {
                  const newAddress = document.getElementById('editedAddress').value.trim();
                  if (!newAddress) {
                      showError('Please enter a valid address');
                      return;
                  }
                  response = await axios.post(`/api/carpenter-assignment/update-address/${bookingId}`, { address: newAddress });

              } else if (selectedOption === 'pincode') {
                  const pincode = document.getElementById('manualPincode').value;
                  if (!pincode || !/^[0-9]{6}$/.test(pincode)) {
                      showError('Please enter a valid 6-digit pincode');
                      return;
                  }
                  response = await axios.post(`/api/carpenter-assignment/update-geocode/${bookingId}?pincode=${pincode}`);

              } else if (selectedOption === 'map') {
                  if (!selectedLocation) {
                      showError('Please select a location on the map');
                      return;
                  }
                  response = await axios.post(`/api/carpenter-assignment/update-coordinates/${bookingId}`, {
                      latitude: selectedLocation.lat,
                      longitude: selectedLocation.lng
                  });
              }

              if (response.data && response.data.success) {
                  showToast('Location updated!', 'success');

                  failedGeocodeOrders = failedGeocodeOrders.filter(o => o.id != bookingId);

                  closeGeocodeModal();

                  if (failedGeocodeOrders.length > 0) {
                      setTimeout(() => processFailedGeocodes(), 300);
                  } else {
                      await autoGenerateRouteAfterFixes();
                  }
              } else {
                  showError(response.data?.message || 'Update failed');
              }
          } catch (error) {
              console.error('Error updating location:', error);
              showError('Error updating location: ' + (error.response?.data?.message || error.message));
          }
      }

      async function autoGenerateRouteAfterFixes() {
          if (!lastAssignmentContext.carpenterId || !lastAssignmentContext.routeDate || !lastAssignmentContext.startPincode) {
              console.warn('No assignment context found. Skipping auto-route generation.');
              loadOrders();
              return;
          }

          try {
              showLoading('All locations fixed! Generating optimized route...', 'Please Wait');

              const routeResponse = await axios.post('/api/carpenter-assignment/generate-route', {
                  carpenterId: lastAssignmentContext.carpenterId,
                  routeDate: lastAssignmentContext.routeDate,
                  startPincode: lastAssignmentContext.startPincode
              });

              closeLoading();

              if (routeResponse.data && routeResponse.data.success) {
                  Swal.fire({
                      icon: 'success',
                      title: 'Route Optimized Successfully!',
                      html: `
                          <div class="text-left space-y-2">
                              <p><strong>‚úÖ All locations fixed and verified</strong></p>
                              <p><strong>üìç Total Distance:</strong> ${routeResponse.data.totalDistance || '-'}</p>
                              <p><strong>‚è±Ô∏è Estimated Time:</strong> ${routeResponse.data.totalDuration || '-'}</p>
                              <p><strong>üì¶ Orders in Route:</strong> ${routeResponse.data.ordersInRoute || '-'}</p>
                          </div>
                      `,
                      confirmButtonColor: '#10b981',
                      confirmButtonText: 'Great!'
                  });

                  lastAssignmentContext = { carpenterId: null, routeDate: null, startPincode: null };
                  selectedOrders.clear();
                  updateSelectionUI();
                  closeAssignModal();
                  loadOrders();
              } else {
                  showError('Route generation failed: ' + (routeResponse.data?.message || 'Unknown'));
                  loadOrders();
              }
          } catch (error) {
              closeLoading();
              console.error('Error auto-generating route:', error);
              showError('Failed to generate route: ' + (error.response?.data?.message || error.message));
              loadOrders();
          }
      }

      function viewOrderDetails(orderId) {
          showInfo('View order details: ' + orderId);
      }

      function formatDate(dateString) {
          if (!dateString) return 'N/A';
          const date = new Date(dateString);
          return date.toLocaleDateString('en-IN');
      }
  /*]]>*/
</script>

</body>
</html>
