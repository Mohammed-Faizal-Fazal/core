<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="fragments/head :: common-head('My Jobs')"></head>
<body class="bg-gray-50">
<div th:replace="fragments/carpenter-navigation :: navbar"></div>

<div class="container mx-auto px-4 py-8">
    <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-800">
            <i class="bi bi-briefcase"></i> My Jobs
        </h2>
        <p class="text-gray-600">View and manage your assigned jobs</p>
    </div>

    <!-- Filter Tabs -->
    <div class="bg-white rounded-xl shadow-md p-4 mb-6">
        <div class="flex space-x-4 flex-wrap gap-2">
            <button id="filterAll" onclick="filterJobs('ALL')" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold">
                <i class="bi bi-list"></i> All (<span id="countAll">0</span>)
            </button>
            <button id="filterAssigned" onclick="filterJobs('ASSIGNED')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
                <i class="bi bi-clock"></i> Pending (<span id="countAssigned">0</span>)
            </button>
            <button id="filterInProgress" onclick="filterJobs('IN_PROGRESS')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
                <i class="bi bi-play-circle"></i> In Progress (<span id="countInProgress">0</span>)
            </button>
            <button id="filterCompleted" onclick="filterJobs('COMPLETED')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
                <i class="bi bi-check-circle"></i> Completed (<span id="countCompleted">0</span>)
            </button>
            <button id="filterFailed" onclick="filterJobs('FAILED')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
                <i class="bi bi-x-circle"></i> Failed (<span id="countFailed">0</span>)
            </button>
        </div>
    </div>

    <!-- Jobs List -->
    <div id="jobsContainer" class="space-y-4">
        <div class="text-center py-8 text-gray-500">
            <i class="bi bi-hourglass-split text-3xl"></i>
            <p class="mt-2">Loading jobs...</p>
        </div>
    </div>
</div>

<!-- Job Details Modal -->
<div id="jobDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
            <h3 class="text-2xl font-bold text-gray-800">
                <i class="bi bi-info-circle"></i> Job Details
            </h3>
            <button onclick="closeJobDetailsModal()" class="text-gray-500 hover:text-gray-700">
                <i class="bi bi-x-lg text-2xl"></i>
            </button>
        </div>

        <div id="jobDetailsContent" class="p-6">
            <!-- Content loaded dynamically -->
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div id="updateStatusModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
            <h3 class="text-2xl font-bold text-gray-800">
                <i class="bi bi-pencil-square"></i> Update Job Status
            </h3>
            <button onclick="closeUpdateStatusModal()" class="text-gray-500 hover:text-gray-700">
                <i class="bi bi-x-lg text-2xl"></i>
            </button>
        </div>

        <form id="updateStatusForm" class="p-6">
            <input type="hidden" id="updateJobId">

            <!-- Current Status Display -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                <p class="text-sm text-gray-600">Current Status</p>
                <p class="text-lg font-bold text-blue-800" id="currentStatus">-</p>
            </div>

            <!-- New Status Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Update Status To: *
                </label>
                <select id="newStatus" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                    <option value="">Select New Status</option>
                    <option value="IN_PROGRESS">In Progress</option>
                    <option value="COMPLETED">Completed (Success)</option>
                    <option value="FAILED">Failed</option>
                </select>
            </div>

            <!-- Notes -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Notes / Comments
                </label>
                <textarea id="statusNotes" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Add any notes about this job..."></textarea>
            </div>

            <!-- Image Upload -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="bi bi-camera"></i> Upload Job Images
                </label>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                    <input type="file" id="jobImages" accept="image/*" multiple class="hidden" onchange="handleImageUpload(event)">
                    <button type="button" onclick="document.getElementById('jobImages').click()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
                        <i class="bi bi-camera"></i> Take/Upload Photos
                    </button>
                    <p class="text-sm text-gray-500 mt-2">You can upload multiple images</p>
                </div>

                <!-- Image Preview -->
                <div id="imagePreviewContainer" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 hidden">
                    <!-- Previews loaded here -->
                </div>
            </div>

            <!-- Camera Capture (Mobile) -->
            <div class="mb-6">
                <button type="button" onclick="openCamera()" class="w-full bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition font-semibold">
                    <i class="bi bi-camera-fill"></i> Open Camera (Mobile)
                </button>
            </div>

            <!-- Submit Buttons -->
            <div class="flex space-x-4">
                <button type="submit" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-semibold">
                    <i class="bi bi-check-circle"></i> Update Status
                </button>
                <button type="button" onclick="closeUpdateStatusModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition font-semibold">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    const csrfToken = /*[[${_csrf.token}]]*/ 'default-token';
    const csrfHeader = /*[[${_csrf.headerName}]]*/ 'X-CSRF-TOKEN';
    axios.defaults.headers.common[csrfHeader] = csrfToken;

    let allJobs = [];
    let currentFilter = 'ALL';
    let currentCarpenterId = null;
    let uploadedImages = [];

    document.addEventListener('DOMContentLoaded', function() {
        fetchCarpenterIdAndLoadJobs();
    });

    async function fetchCarpenterIdAndLoadJobs() {
        try {
            const response = await axios.get('/api/carpenters/current');
            if (response.data && response.data.carpenterId) {
                currentCarpenterId = response.data.carpenterId;
                loadAllJobs();
            }
        } catch (error) {
            console.error('Error fetching carpenter ID:', error);
            showMessage('Error loading carpenter information');
        }
    }

    async function loadAllJobs() {
        try {
            const response = await axios.get(`/api/carpenter-jobs/${currentCarpenterId}`);
            allJobs = response.data || [];
            updateJobCounts();
            renderJobs();
        } catch (error) {
            console.error('Error loading jobs:', error);
            document.getElementById('jobsContainer').innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <i class="bi bi-exclamation-triangle text-3xl"></i>
                    <p class="mt-2">Error loading jobs</p>
                </div>
            `;
        }
    }

    function updateJobCounts() {
        const counts = {
            ALL: allJobs.length,
            ASSIGNED: allJobs.filter(j => j.assignmentStatus === 'ASSIGNED').length,
            IN_PROGRESS: allJobs.filter(j => j.assignmentStatus === 'IN_PROGRESS').length,
            COMPLETED: allJobs.filter(j => j.assignmentStatus === 'COMPLETED').length,
            FAILED: allJobs.filter(j => j.assignmentStatus === 'FAILED').length
        };

        document.getElementById('countAll').textContent = counts.ALL;
        document.getElementById('countAssigned').textContent = counts.ASSIGNED;
        document.getElementById('countInProgress').textContent = counts.IN_PROGRESS;
        document.getElementById('countCompleted').textContent = counts.COMPLETED;
        document.getElementById('countFailed').textContent = counts.FAILED;
    }

    function filterJobs(status) {
        currentFilter = status;

        // Update button styles
        document.querySelectorAll('[id^="filter"]').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'bg-orange-600', 'bg-green-600', 'bg-red-600', 'text-white');
            btn.classList.add('bg-gray-200', 'text-gray-700');
        });

        const activeBtn = document.getElementById('filter' + status.charAt(0) + status.slice(1).toLowerCase().replace('_', ''));
        if (activeBtn) {
            activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
            if (status === 'ASSIGNED') {
                activeBtn.classList.add('bg-orange-600', 'text-white');
            } else if (status === 'COMPLETED') {
                activeBtn.classList.add('bg-green-600', 'text-white');
            } else if (status === 'FAILED') {
                activeBtn.classList.add('bg-red-600', 'text-white');
            } else {
                activeBtn.classList.add('bg-blue-600', 'text-white');
            }
        }

        renderJobs();
    }

    function renderJobs() {
        const container = document.getElementById('jobsContainer');

        let filteredJobs = allJobs;
        if (currentFilter !== 'ALL') {
            filteredJobs = allJobs.filter(j => j.assignmentStatus === currentFilter);
        }

        if (filteredJobs.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="bi bi-inbox text-3xl"></i>
                    <p class="mt-2">No jobs found for this filter</p>
                </div>
            `;
            return;
        }

        container.innerHTML = filteredJobs.map(job => {
            const pincode = extractPincodeFromAddress(job.address);
            return `
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">${job.orderNo || 'Order #' + job.id}</h3>
                            <p class="text-gray-600">${job.serviceName || 'Service'}</p>
                            <p class="text-sm text-gray-500 mt-1">
                                <i class="bi bi-calendar"></i> ${formatDate(job.assignedDate)}
                            </p>
                        </div>
                        <span class="px-4 py-2 rounded-full text-sm font-semibold ${getStatusBadgeClass(job.assignmentStatus)}">
                            ${getStatusLabel(job.assignmentStatus)}
                        </span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="text-sm font-medium text-gray-600">Customer</label>
                            <p class="text-gray-900">${job.customerName || 'N/A'}</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">Phone</label>
                            <p class="text-gray-900">${job.customerMobile || 'N/A'}</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">Address</label>
                            <p class="text-gray-900 truncate" title="${job.address || 'N/A'}">${job.address || 'N/A'}</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">Pincode</label>
                            <p class="text-gray-900 font-semibold text-blue-600">${pincode || 'N/A'}</p>
                        </div>
                    </div>

                    <div class="flex space-x-2 flex-wrap gap-2">
                        ${job.assignmentStatus === 'ASSIGNED' ? `
                            <button onclick="updateJobStatus(${job.id})" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                                <i class="bi bi-play-circle"></i> Start Job
                            </button>
                        ` : ''}

                        ${job.assignmentStatus === 'IN_PROGRESS' ? `
                            <button onclick="updateJobStatus(${job.id})" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                                <i class="bi bi-check-circle"></i> Mark Complete
                            </button>
                        ` : ''}

                        <button onclick="viewJobDetails(${job.id})" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">
                            <i class="bi bi-eye"></i> View Details
                        </button>

                        ${job.latitude && job.longitude ? `
                            <button onclick="navigateToJob(${job.latitude}, ${job.longitude})" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
                                <i class="bi bi-navigation"></i> Navigate
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    function extractPincodeFromAddress(address) {
        if (!address) return null;
        const lastDashIndex = address.lastIndexOf('-');
        if (lastDashIndex === -1) return null;
        const afterDash = address.substring(lastDashIndex + 1).trim();
        if (/^[0-9]{6}$/.test(afterDash)) {
            return afterDash;
        }
        return null;
    }

    function updateJobStatus(jobId) {
        const job = allJobs.find(j => j.id === jobId);
        if (!job) return;

        document.getElementById('updateJobId').value = jobId;
        document.getElementById('currentStatus').textContent = getStatusLabel(job.assignmentStatus);
        document.getElementById('newStatus').value = '';
        document.getElementById('statusNotes').value = '';
        document.getElementById('imagePreviewContainer').classList.add('hidden');
        uploadedImages = [];

        document.getElementById('updateStatusModal').classList.remove('hidden');
    }

    function closeUpdateStatusModal() {
        document.getElementById('updateStatusModal').classList.add('hidden');
        document.getElementById('updateStatusForm').reset();
        uploadedImages = [];
    }

    document.getElementById('updateStatusForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const jobId = document.getElementById('updateJobId').value;
        const newStatus = document.getElementById('newStatus').value;
        const notes = document.getElementById('statusNotes').value;

        if (!newStatus) {
            alert('Please select a new status');
            return;
        }

        try {
            const formData = new FormData();
            formData.append('status', newStatus);
            formData.append('notes', notes);

            uploadedImages.forEach((image, index) => {
                formData.append('images', image);
            });

            const response = await axios.post(`/api/carpenter-jobs/${jobId}/update-status`, formData, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            });

            if (response.data.success) {
                showMessage('Job status updated successfully!', 'success');
                closeUpdateStatusModal();
                loadAllJobs();
            } else {
                showMessage(response.data.message, 'error');
            }
        } catch (error) {
            console.error('Error updating status:', error);
            showMessage('Error updating job status', 'error');
        }
    });

    function handleImageUpload(event) {
        const files = Array.from(event.target.files);
        uploadedImages = [...uploadedImages, ...files];

        displayImagePreviews();
    }

    function displayImagePreviews() {
        const container = document.getElementById('imagePreviewContainer');
        container.classList.remove('hidden');

        container.innerHTML = uploadedImages.map((file, index) => `
            <div class="relative">
                <img src="${URL.createObjectURL(file)}" class="w-full h-32 object-cover rounded-lg">
                <button type="button" onclick="removeImage(${index})" class="absolute top-1 right-1 bg-red-600 text-white rounded-full p-1 hover:bg-red-700">
                    <i class="bi bi-x text-sm"></i>
                </button>
            </div>
        `).join('');
    }

    function removeImage(index) {
        uploadedImages.splice(index, 1);
        displayImagePreviews();

        if (uploadedImages.length === 0) {
            document.getElementById('imagePreviewContainer').classList.add('hidden');
        }
    }

    function openCamera() {
        const input = document.getElementById('jobImages');
        input.setAttribute('capture', 'environment');
        input.click();
    }

    function viewJobDetails(jobId) {
        const job = allJobs.find(j => j.id === jobId);
        if (!job) return;

        const pincode = extractPincodeFromAddress(job.address);

        const detailsHtml = `
            <div class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">Order Information</h4>
                        <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                            <p><span class="font-medium">Order No:</span> ${job.orderNo || 'N/A'}</p>
                            <p><span class="font-medium">Service:</span> ${job.serviceName || 'N/A'}</p>
                            <p><span class="font-medium">Assigned Date:</span> ${formatDate(job.assignedDate)}</p>
                            <p><span class="font-medium">Status:</span> <span class="px-3 py-1 rounded-full text-xs font-semibold ${getStatusBadgeClass(job.assignmentStatus)}">${getStatusLabel(job.assignmentStatus)}</span></p>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">Customer Information</h4>
                        <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                            <p><span class="font-medium">Name:</span> ${job.customerName || 'N/A'}</p>
                            <p><span class="font-medium">Phone:</span> <a href="tel:${job.customerMobile}" class="text-blue-600 hover:underline">${job.customerMobile || 'N/A'}</a></p>
                            <p><span class="font-medium">Address:</span> ${job.address || 'N/A'}</p>
                            <p><span class="font-medium">Pincode:</span> <span class="font-semibold text-blue-600">${pincode || 'N/A'}</span></p>
                        </div>
                    </div>
                </div>

                ${job.notes ? `
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">Notes</h4>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p>${job.notes}</p>
                        </div>
                    </div>
                ` : ''}

                <div class="flex space-x-4">
                    <button onclick="closeJobDetailsModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition font-semibold">
                        Close
                    </button>
                </div>
            </div>
        `;

        document.getElementById('jobDetailsContent').innerHTML = detailsHtml;
        document.getElementById('jobDetailsModal').classList.remove('hidden');
    }

    function closeJobDetailsModal() {
        document.getElementById('jobDetailsModal').classList.add('hidden');
    }

    function navigateToJob(lat, lng) {
        const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
        window.open(url, '_blank');
    }

    function getStatusLabel(status) {
        const labels = {
            'ASSIGNED': 'Pending',
            'IN_PROGRESS': 'In Progress',
            'COMPLETED': 'Completed',
            'FAILED': 'Failed'
        };
        return labels[status] || status;
    }

    function getStatusBadgeClass(status) {
        const classes = {
            'ASSIGNED': 'bg-orange-100 text-orange-800',
            'IN_PROGRESS': 'bg-blue-100 text-blue-800',
            'COMPLETED': 'bg-green-100 text-green-800',
            'FAILED': 'bg-red-100 text-red-800'
        };
        return classes[status] || 'bg-gray-100 text-gray-800';
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-IN', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    function showMessage(message, type = 'info') {
        alert(message);
    }
    /*]]>*/
</script>

</body>
</html>