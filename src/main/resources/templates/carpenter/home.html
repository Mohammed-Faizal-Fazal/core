<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="fragments/head :: common-head('Carpenter Dashboard')"></head>
<body class="bg-gray-50">
<div th:replace="fragments/carpenter-navigation :: navbar"></div>

<div class="container mx-auto px-4 py-8">
    <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-800">
            <i class="bi bi-person-workspace"></i> Welcome, <span sec:authentication="principal.fullName">Carpenter</span>!
        </h2>
        <p class="text-gray-600">Mobile: <span sec:authentication="principal.phoneNumber">9876543210</span></p>
    </div>

    <!-- Dashboard Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm">Pending Jobs</p>
                    <h3 class="text-3xl font-bold text-orange-600" id="pendingCount">
                        <i class="bi bi-hourglass-split animate-spin"></i>
                    </h3>
                </div>
                <div class="bg-orange-100 rounded-full p-4">
                    <i class="bi bi-clock-history text-3xl text-orange-600"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm">Completed Today</p>
                    <h3 class="text-3xl font-bold text-green-600" id="completedTodayCount">
                        <i class="bi bi-hourglass-split animate-spin"></i>
                    </h3>
                </div>
                <div class="bg-green-100 rounded-full p-4">
                    <i class="bi bi-check-circle text-3xl text-green-600"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm">Total This Month</p>
                    <h3 class="text-3xl font-bold text-blue-600" id="monthlyCount">
                        <i class="bi bi-hourglass-split animate-spin"></i>
                    </h3>
                </div>
                <div class="bg-blue-100 rounded-full p-4">
                    <i class="bi bi-calendar-check text-3xl text-blue-600"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Info -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-6" id="profileSection">
        <h3 class="text-xl font-bold mb-4"><i class="bi bi-person-badge"></i> Your Profile</h3>
        <div class="text-center py-4">
            <i class="bi bi-hourglass-split text-3xl text-gray-400 animate-spin"></i>
            <p class="text-gray-500 mt-2">Loading profile...</p>
        </div>
    </div>

    <!-- Recent Jobs -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-xl font-bold mb-4"><i class="bi bi-briefcase"></i> Recent Jobs</h3>
        <div id="recentJobsContainer" class="space-y-4">
            <div class="text-center py-4">
                <i class="bi bi-hourglass-split text-3xl text-gray-400 animate-spin"></i>
                <p class="text-gray-500 mt-2">Loading recent jobs...</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    const csrfToken = /*[[${_csrf.token}]]*/ 'default-token';
    const csrfHeader = /*[[${_csrf.headerName}]]*/ 'X-CSRF-TOKEN';
    axios.defaults.headers.common[csrfHeader] = csrfToken;

    let currentCarpenterId = null;
    let carpenterInfo = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
    });

    async function loadDashboardData() {
        try {
            // Load carpenter info
            const carpenterResponse = await axios.get('/api/carpenters/current');
            if (carpenterResponse.data && carpenterResponse.data.carpenterId) {
                currentCarpenterId = carpenterResponse.data.carpenterId;
                carpenterInfo = carpenterResponse.data;

                // Load profile
                loadProfile();

                // Load jobs
                await loadJobsData();
            } else {
                showError('Unable to load carpenter information');
            }
        } catch (error) {
            console.error('Error loading dashboard:', error);
            showError('Error loading dashboard data');
        }
    }

    function loadProfile() {
        const profileHtml = `
            <h3 class="text-xl font-bold mb-4"><i class="bi bi-person-badge"></i> Your Profile</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-medium text-gray-700">Carpenter ID</label>
                    <p class="text-gray-900">${carpenterInfo.carpenterId || '-'}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">Name</label>
                    <p class="text-gray-900">${carpenterInfo.name || '-'}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">Mobile</label>
                    <p class="text-gray-900">${carpenterInfo.mobile || '-'}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">City</label>
                    <p class="text-gray-900">${carpenterInfo.cityCode || '-'}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">Branch</label>
                    <p class="text-gray-900">${carpenterInfo.branchCode || '-'}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">Status</label>
                    <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                        Active
                    </span>
                </div>
            </div>
        `;
        document.getElementById('profileSection').innerHTML = profileHtml;
    }

    async function loadJobsData() {
        try {
            const response = await axios.get(`/api/carpenter-jobs/${currentCarpenterId}`);
            const allJobs = response.data || [];

            // Calculate stats
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const pendingCount = allJobs.filter(j => j.assignmentStatus === 'ASSIGNED').length;
            const completedToday = allJobs.filter(j => {
                if (j.assignmentStatus !== 'COMPLETED') return false;
                const jobDate = j.completedDate || j.assignedDate;
                return jobDate && jobDate.startsWith(today);
            }).length;

            const monthlyCount = allJobs.filter(j => {
                const jobDate = j.assignedDate;
                if (!jobDate) return false;
                const date = new Date(jobDate);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            }).length;

            // Update counts
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('completedTodayCount').textContent = completedToday;
            document.getElementById('monthlyCount').textContent = monthlyCount;

            // Load recent jobs (last 5)
            const recentJobs = allJobs
                .sort((a, b) => new Date(b.assignedDate || 0) - new Date(a.assignedDate || 0))
                .slice(0, 5);

            renderRecentJobs(recentJobs);
        } catch (error) {
            console.error('Error loading jobs:', error);
            document.getElementById('pendingCount').textContent = '0';
            document.getElementById('completedTodayCount').textContent = '0';
            document.getElementById('monthlyCount').textContent = '0';
            document.getElementById('recentJobsContainer').innerHTML = `
                <div class="text-center py-4 text-gray-500">
                    <i class="bi bi-inbox text-3xl"></i>
                    <p class="mt-2">No jobs assigned yet</p>
                </div>
            `;
        }
    }

    function renderRecentJobs(jobs) {
        const container = document.getElementById('recentJobsContainer');

        if (!jobs || jobs.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4 text-gray-500">
                    <i class="bi bi-inbox text-3xl"></i>
                    <p class="mt-2">No recent jobs</p>
                </div>
            `;
            return;
        }

        container.innerHTML = jobs.map(job => `
            <div class="border-l-4 ${getBorderColor(job.assignmentStatus)} pl-4 py-2 ${getBgColor(job.assignmentStatus)}">
                <div class="flex justify-between items-start flex-wrap gap-2">
                    <div>
                        <h4 class="font-semibold text-gray-800">${job.orderNo || 'Order #' + job.id}</h4>
                        <p class="text-sm text-gray-600">${job.serviceName || 'Service'}</p>
                        <p class="text-xs text-gray-500 mt-1">
                            ${job.assignmentStatus === 'COMPLETED' ? 'Completed' : 'Scheduled'}: ${formatDate(job.assignedDate)}
                        </p>
                    </div>
                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${getStatusBadgeClass(job.assignmentStatus)}">
                        ${getStatusLabel(job.assignmentStatus)}
                    </span>
                </div>
            </div>
        `).join('');
    }

    function getBorderColor(status) {
        const colors = {
            'ASSIGNED': 'border-orange-500',
            'IN_PROGRESS': 'border-blue-500',
            'COMPLETED': 'border-green-500',
            'FAILED': 'border-red-500'
        };
        return colors[status] || 'border-gray-500';
    }

    function getBgColor(status) {
        const colors = {
            'ASSIGNED': 'bg-orange-50',
            'IN_PROGRESS': 'bg-blue-50',
            'COMPLETED': 'bg-green-50',
            'FAILED': 'bg-red-50'
        };
        return colors[status] || 'bg-gray-50';
    }

    function getStatusBadgeClass(status) {
        const classes = {
            'ASSIGNED': 'bg-orange-100 text-orange-800',
            'IN_PROGRESS': 'bg-blue-100 text-blue-800',
            'COMPLETED': 'bg-green-100 text-green-800',
            'FAILED': 'bg-red-100 text-red-800'
        };
        return classes[status] || 'bg-gray-100 text-gray-800';
    }

    function getStatusLabel(status) {
        const labels = {
            'ASSIGNED': 'Pending',
            'IN_PROGRESS': 'In Progress',
            'COMPLETED': 'Completed',
            'FAILED': 'Failed'
        };
        return labels[status] || status;
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-IN', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function showError(message) {
        document.getElementById('pendingCount').textContent = '-';
        document.getElementById('completedTodayCount').textContent = '-';
        document.getElementById('monthlyCount').textContent = '-';
        document.getElementById('profileSection').innerHTML = `
            <div class="text-center py-4 text-red-500">
                <i class="bi bi-exclamation-triangle text-3xl"></i>
                <p class="mt-2">${message}</p>
            </div>
        `;
        document.getElementById('recentJobsContainer').innerHTML = `
            <div class="text-center py-4 text-red-500">
                <i class="bi bi-exclamation-triangle text-3xl"></i>
                <p class="mt-2">${message}</p>
            </div>
        `;
    }
    /*]]>*/
</script>

</body>
</html>