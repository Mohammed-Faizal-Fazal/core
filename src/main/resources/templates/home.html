<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="fragments/head :: common-head('Items')"></head>
<body class="bg-gray-50">
<div th:replace="fragments/navigation :: navbar"></div>

<!-- Main Content -->
<div class="container mx-auto px-4 py-8">

    <!-- Welcome Card -->
    <div class="gradient-bg text-white rounded-2xl shadow-lg p-8 mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-3xl font-bold mb-2">
                    <i class="bi bi-emoji-smile"></i> Welcome back, <span sec:authentication="name"></span>!
                </h2>
                <p class="opacity-90 text-lg">
                    <strong>INSTAFITCORE</strong> - One Stop Solutions |
                    Role: <strong sec:authentication="principal.authorities"></strong>
                </p>
            </div>
            <div>
                <i class="bi bi-house-heart text-6xl opacity-30"></i>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500 hover:shadow-lg transition">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-gray-500 text-sm mb-1 font-medium">Total Bookings</p>
                    <h3 class="text-3xl font-bold text-gray-800" id="totalBookings">0</h3>
                </div>
                <div class="bg-green-100 p-4 rounded-lg">
                    <i class="bi bi-calendar-check text-3xl text-green-600"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-yellow-500 hover:shadow-lg transition">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-gray-500 text-sm mb-1 font-medium">Pending (Not Submitted)</p>
                    <h3 class="text-3xl font-bold text-gray-800" id="pendingBookings">0</h3>
                </div>
                <div class="bg-yellow-100 p-4 rounded-lg">
                    <i class="bi bi-clock text-3xl text-yellow-600"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500 hover:shadow-lg transition">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-gray-500 text-sm mb-1 font-medium">Submitted</p>
                    <h3 class="text-3xl font-bold text-gray-800" id="submittedBookings">0</h3>
                </div>
                <div class="bg-blue-100 p-4 rounded-lg">
                    <i class="bi bi-check-circle text-3xl text-blue-600"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-8">
        <h5 class="text-xl font-bold mb-4 text-gray-800">
            <i class="bi bi-lightning-fill text-yellow-500"></i> Quick Actions
        </h5>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <a href="/bookings" class="gradient-bg text-white text-center py-4 rounded-lg hover:opacity-90 transition font-semibold">
                <i class="bi bi-calendar-check"></i> View Bookings
            </a>
            <a href="/submitted-orders" class="bg-green-600 text-white text-center py-4 rounded-lg hover:bg-green-700 transition font-semibold">
                <i class="bi bi-check-circle"></i> Submitted Orders
            </a>
            <button onclick="refreshStats()" class="bg-blue-600 text-white py-4 rounded-lg hover:bg-blue-700 transition font-semibold">
                <i class="bi bi-arrow-clockwise"></i> Refresh Stats
            </button>
        </div>

        <!-- Optional: last updated text -->
        <p class="text-xs text-gray-500 mt-4" id="statsUpdatedAt">Last updated: -</p>
    </div>

</div>

<!-- Footer -->
<footer class="bg-gray-900 text-white text-center py-6 mt-12">
    <div class="container mx-auto">
        <p class="mb-1">&copy; 2026 INSTAFITCORE - One Stop Solutions. All rights reserved.</p>
        <p class="text-sm text-gray-400">Furniture Service | Transportation | Complete Solutions</p>
    </div>
</footer>

<script>
    // Configure Axios with CSRF token (Spring Security)
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
    axios.defaults.headers.common[csrfHeader] = csrfToken;

    // Frontend-only cache so if API fails you can still show last known counts
    const STATS_CACHE_KEY = 'instafit_home_stats_cache_v1';

    function saveStatsCache(stats) {
        try { localStorage.setItem(STATS_CACHE_KEY, JSON.stringify(stats)); } catch (e) {}
    }

    function loadStatsCache() {
        try {
            const raw = localStorage.getItem(STATS_CACHE_KEY);
            return raw ? JSON.parse(raw) : null;
        } catch (e) {
            return null;
        }
    }

    function setCounts(total, pending, submitted) {
        document.getElementById('totalBookings').textContent = total ?? 0;
        document.getElementById('pendingBookings').textContent = pending ?? 0;
        document.getElementById('submittedBookings').textContent = submitted ?? 0;
    }

    function setUpdatedAt(dateObj) {
        const el = document.getElementById('statsUpdatedAt');
        if (!el) return;
        el.textContent = 'Last updated: ' + (dateObj ? dateObj.toLocaleString() : '-');
    }

    async function loadStats() {

        const ENDPOINT = '/api/bookings';

        try {
            const response = await axios.get(ENDPOINT);
            const bookings = Array.isArray(response.data) ? response.data : [];

            const total = bookings.length;
            const submitted = bookings.filter(b => b.status === 'Submitted').length;
            const pending = bookings.filter(b => b.status !== 'Submitted').length;

            setCounts(total, pending, submitted);

            const now = new Date();
            setUpdatedAt(now);

            saveStatsCache({ total, pending, submitted, updatedAt: now.toISOString() });
        } catch (error) {
            console.error('Error loading stats:', error);

            const cached = loadStatsCache();
            if (cached) {
                setCounts(cached.total, cached.pending, cached.submitted);
                setUpdatedAt(cached.updatedAt ? new Date(cached.updatedAt) : null);

                Swal.fire({
                    icon: 'warning',
                    title: 'Stats fetch failed',
                    text: 'Showing last saved counts from browser cache.',
                    confirmButtonColor: '#689F38'
                });
            } else {
                setCounts(0, 0, 0);
                setUpdatedAt(null);

                Swal.fire({
                    icon: 'error',
                    title: 'Stats fetch failed',
                    text: 'Could not load stats and no saved data exists in browser cache.',
                    confirmButtonColor: '#689F38'
                });
            }
        }
    }

    async function refreshStats() {
        // Nice toast
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'info',
            title: 'Refreshing stats...',
            showConfirmButton: false,
            timer: 1200,
            timerProgressBar: true
        });

        await loadStats();

        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'success',
            title: 'Stats updated',
            showConfirmButton: false,
            timer: 1800,
            timerProgressBar: true
        });
    }


    loadStats();
</script>

</body>
</html>
