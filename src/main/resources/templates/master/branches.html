<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="fragments/head :: common-head('Branches')"></head>

<!-- SweetAlert2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<body class="bg-gray-50">
<div th:replace="fragments/navigation :: navbar"></div>

<div class="container mx-auto px-4 py-8">
    <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-800">
            <i class="bi bi-building"></i> Branches Master
        </h2>
        <p class="text-gray-600">Manage branch codes and city associations</p>
    </div>
    <div id="react-root"></div>
</div>

<!-- Add/Edit Modal -->
<div id="branchModal" class="modal">
    <div class="modal-content">
        <div class="gradient-bg text-white p-6 rounded-t-xl">
            <h3 class="text-2xl font-bold" id="modalTitle"><i class="bi bi-plus-circle"></i> Add Branch</h3>
        </div>
        <div class="p-6">
            <form id="branchForm">
                <input type="hidden" id="branchId">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Branch Code *</label>
                    <input type="text" id="branchCode" maxlength="20"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent uppercase"
                           placeholder="e.g., BR001" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Branch Description *</label>
                    <input type="text" id="branchDesc" maxlength="200"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="e.g., Main Branch" required>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">City Codes (Comma Separated)</label>
                    <input type="text" id="cityCodes"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent uppercase"
                           placeholder="e.g., HYD,BLR,CHN">
                    <p class="text-xs text-gray-500 mt-1">Enter city codes separated by commas. Leave empty if not applicable.</p>
                </div>
                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 gradient-bg text-white py-3 rounded-lg hover:opacity-90 transition font-semibold">
                        <i class="bi bi-save"></i> Save
                    </button>
                    <button type="button" onclick="closeModal()" class="flex-1 bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-700 transition font-semibold">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- React + Babel + Axios -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- âœ… SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- JSX stored inside a JS string so Thymeleaf never parses it -->
<script th:inline="none">
    const BRANCHES_JSX = `
      const { useState, useEffect } = React;

      const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
      axios.defaults.headers.common[csrfHeader] = csrfToken;

      function toastSuccess(message){
        Swal.fire({ icon: 'success', title: 'Success', text: message, timer: 1800, showConfirmButton: false });
      }
      function toastError(message){
        Swal.fire({ icon: 'error', title: 'Error', text: message });
      }
      function showLoading(title='Please wait...'){
        Swal.fire({ title, allowOutsideClick:false, didOpen: () => Swal.showLoading() });
      }

      function BranchesManager() {
          const [branches, setBranches] = useState([]);
          const [loading, setLoading] = useState(false);
          const [filter, setFilter] = useState('all');

          useEffect(() => { fetchBranches(); }, []);

          const fetchBranches = async () => {
              setLoading(true);
              try {
                  const response = await axios.get('/api/master/branches');
                  setBranches(response.data);
              } catch (error) {
                  console.error('Error fetching branches:', error);
                  toastError('Failed to fetch branches');
              } finally {
                  setLoading(false);
              }
          };

          const openAddModal = () => {
              document.getElementById('branchId').value = '';
              document.getElementById('branchCode').value = '';
              document.getElementById('branchDesc').value = '';
              document.getElementById('cityCodes').value = '';
              document.getElementById('branchCode').disabled = false;
              document.getElementById('modalTitle').innerHTML = '<i class="bi bi-plus-circle"></i> Add Branch';
              document.getElementById('branchModal').classList.add('show');
          };

          const openEditModal = (branch) => {
              document.getElementById('branchId').value = branch.id;
              document.getElementById('branchCode').value = branch.branchCode;
              document.getElementById('branchDesc').value = branch.branchDesc;
              document.getElementById('cityCodes').value = branch.cityCodes || '';
              document.getElementById('branchCode').disabled = true;
              document.getElementById('modalTitle').innerHTML = '<i class="bi bi-pencil-square"></i> Edit Branch';
              document.getElementById('branchModal').classList.add('show');
          };

          const toggleActive = async (id) => {
              const result = await Swal.fire({
                icon: 'question',
                title: 'Toggle Status?',
                text: 'Are you sure you want to change active/inactive?',
                showCancelButton: true,
                confirmButtonText: 'Yes, change',
                cancelButtonText: 'Cancel'
              });
              if (!result.isConfirmed) return;

              try {
                  showLoading('Updating status...');
                  const response = await axios.post(\`/api/master/branches/\${id}/toggle-active\`);
                  Swal.close();
                  if (response.data.success) {
                      toastSuccess(response.data.message || 'Status updated');
                      fetchBranches();
                  } else {
                      toastError(response.data.message || 'Failed to toggle status');
                  }
              } catch (error) {
                  Swal.close();
                  console.error('Error toggling status:', error);
                  toastError('Failed to toggle status');
              }
          };

          const deleteBranch = async (id) => {
              const result = await Swal.fire({
                icon: 'warning',
                title: 'Delete Branch?',
                text: 'This action cannot be undone.',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete',
                confirmButtonColor: '#d33',
                cancelButtonText: 'Cancel'
              });
              if (!result.isConfirmed) return;

              try {
                  showLoading('Deleting...');
                  const response = await axios.delete(\`/api/master/branches/\${id}\`);
                  Swal.close();
                  if (response.data.success) {
                      toastSuccess(response.data.message || 'Branch deleted');
                      fetchBranches();
                  } else {
                      toastError(response.data.message || 'Failed to delete');
                  }
              } catch (error) {
                  Swal.close();
                  console.error('Error deleting branch:', error);
                  toastError('Failed to delete branch');
              }
          };

          const handleExcelUpload = async (event) => {
              const file = event.target.files[0];
              if (!file) return;

              const formData = new FormData();
              formData.append('file', file);

              setLoading(true);
              try {
                  showLoading('Uploading file...');
                  const response = await axios.post('/api/master/branches/upload', formData, {
                      headers: { 'Content-Type': 'multipart/form-data' }
                  });
                  Swal.close();

                  if (response.data.success) {
                      toastSuccess(response.data.message || 'Upload successful');
                      fetchBranches();
                  } else {
                      toastError(response.data.message || 'Upload failed');
                  }
              } catch (error) {
                  Swal.close();
                  console.error('Error uploading Excel:', error);
                  toastError(error.response?.data?.message || 'Failed to upload Excel');
              } finally {
                  setLoading(false);
                  event.target.value = '';
              }
          };

          const downloadTemplate = () => {
              const template =
                "Branch Code,Branch Description,City Codes\\n" +
                "BR001,Main Branch,\\"HYD,BLR\\"\\n" +
                "BR002,Secondary Branch,\\"CHN,DEL\\"";

              const blob = new Blob([template], { type: 'text/csv' });
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'branches_template.csv';
              a.click();

              Swal.fire({ icon:'info', title:'Template Downloaded', text:'branches_template.csv downloaded.', timer:1500, showConfirmButton:false });
          };

          const filteredBranches = branches.filter(branch => {
              if (filter === 'active') return branch.active;
              if (filter === 'inactive') return !branch.active;
              return true;
          });

          window.openAddModal = openAddModal;
          window.openEditModal = openEditModal;
          window.toggleActive = toggleActive;
          window.deleteBranch = deleteBranch;

          if (loading) {
              return (
                  <div className="text-center py-12">
                      <div className="inline-block animate-spin rounded-full h-16 w-16 border-4 border-green-500 border-t-transparent"></div>
                      <p className="mt-4 text-gray-600">Loading...</p>
                  </div>
              );
          }

          return (
              <div>
                  <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                      <div className="flex flex-wrap items-center justify-between gap-4">
                          <div className="flex items-center space-x-2">
                              <button className="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition font-semibold" onClick={openAddModal}>
                                  <i className="bi bi-plus-circle"></i> Add Branch
                              </button>

                              <label className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-semibold cursor-pointer">
                                  <i className="bi bi-upload"></i> Upload Excel
                                  <input type="file" accept=".xlsx,.xls,.csv" onChange={handleExcelUpload} className="hidden" />
                              </label>

                              <button className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition font-semibold" onClick={downloadTemplate}>
                                  <i className="bi bi-download"></i> Template
                              </button>

                              <button className="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition font-semibold" onClick={fetchBranches}>
                                  <i className="bi bi-arrow-clockwise"></i> Refresh
                              </button>
                          </div>

                          <div className="flex items-center space-x-2">
                              <label className="text-sm font-medium text-gray-700">Filter:</label>
                              <select
                                className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                value={filter}
                                onChange={(e) => setFilter(e.target.value)}
                              >
                                  <option value="all">All ({branches.length})</option>
                                  <option value="active">Active ({branches.filter(b => b.active).length})</option>
                                  <option value="inactive">Inactive ({branches.filter(b => !b.active).length})</option>
                              </select>
                          </div>
                      </div>
                  </div>

                  <div className="bg-white rounded-xl shadow-md overflow-hidden">
                      <div className="overflow-x-auto">
                          <table className="w-full">
                              <thead className="gradient-bg text-white">
                                  <tr>
                                      <th className="px-4 py-3 text-left">#</th>
                                      <th className="px-4 py-3 text-left">Branch Code</th>
                                      <th className="px-4 py-3 text-left">Branch Description</th>
                                      <th className="px-4 py-3 text-left">City Codes</th>
                                      <th className="px-4 py-3 text-left">Status</th>
                                      <th className="px-4 py-3 text-left">Created</th>
                                      <th className="px-4 py-3 text-left">Actions</th>
                                  </tr>
                              </thead>
                              <tbody className="divide-y divide-gray-200">
                                  {filteredBranches.length === 0 ? (
                                      <tr>
                                          <td colSpan="7" className="px-4 py-12 text-center">
                                              <i className="bi bi-inbox text-6xl text-gray-300"></i>
                                              <p className="text-gray-500 mt-4 text-lg">No branches found</p>
                                          </td>
                                      </tr>
                                  ) : (
                                      filteredBranches.map((branch, index) => (
                                          <tr key={branch.id} className="hover:bg-gray-50 transition">
                                              <td className="px-4 py-3">{index + 1}</td>
                                              <td className="px-4 py-3 font-bold text-green-600">{branch.branchCode}</td>
                                              <td className="px-4 py-3">{branch.branchDesc}</td>
                                              <td className="px-4 py-3">
                                                  {branch.cityCodes ? (
                                                      <div className="flex flex-wrap gap-1">
                                                          {branch.cityCodes.split(',').map((city, idx) => (
                                                              <span key={idx} className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-semibold">
                                                                  {city.trim()}
                                                              </span>
                                                          ))}
                                                      </div>
                                                  ) : (
                                                      <span className="text-gray-400 text-sm">No cities</span>
                                                  )}
                                              </td>
                                              <td className="px-4 py-3">
                                                  <span className={\`px-3 py-1 rounded-full text-xs font-semibold \${branch.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}\`}>
                                                      {branch.active ? 'Active' : 'Inactive'}
                                                  </span>
                                              </td>
                                              <td className="px-4 py-3 text-sm text-gray-600">
                                                  {new Date(branch.createdAt).toLocaleDateString()}
                                              </td>
                                              <td className="px-4 py-3">
                                                  <div className="flex space-x-2">
                                                      <button className="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 transition text-sm" onClick={() => openEditModal(branch)} title="Edit">
                                                          <i className="bi bi-pencil"></i>
                                                      </button>
                                                      <button
                                                        className={\`\${branch.active ? 'bg-orange-600 hover:bg-orange-700' : 'bg-green-600 hover:bg-green-700'} text-white px-3 py-1 rounded-lg transition text-sm\`}
                                                        onClick={() => toggleActive(branch.id)}
                                                        title={branch.active ? 'Deactivate' : 'Activate'}
                                                      >
                                                          <i className={\`bi bi-\${branch.active ? 'toggle-on' : 'toggle-off'}\`}></i>
                                                      </button>
                                                      <button className="bg-red-600 text-white px-3 py-1 rounded-lg hover:bg-red-700 transition text-sm" onClick={() => deleteBranch(branch.id)} title="Delete">
                                                          <i className="bi bi-trash"></i>
                                                      </button>
                                                  </div>
                                              </td>
                                          </tr>
                                      ))
                                  )}
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
          );
      }

      const root = ReactDOM.createRoot(document.getElementById('react-root'));
      root.render(<BranchesManager />);
    `;

    (function () {
        const compiled = Babel.transform(BRANCHES_JSX, { presets: ['react'] }).code;
        new Function(compiled)();
    })();
</script>

<!-- Plain JS for modal + submit -->
<script>
    function closeModal() {
        document.getElementById('branchModal').classList.remove('show');
    }

    window.onclick = function(event) {
        const modal = document.getElementById('branchModal');
        if (event.target === modal) {
            closeModal();
        }
    }

    document.getElementById('branchForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const branchId = document.getElementById('branchId').value;
        const cityCodes = document.getElementById('cityCodes').value.trim();

        const data = {
            branchCode: document.getElementById('branchCode').value.toUpperCase(),
            branchDesc: document.getElementById('branchDesc').value,
            cityCodes: cityCodes ? cityCodes.toUpperCase() : null,
            active: true
        };

        try {
            Swal.fire({ title: 'Saving...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            const response = branchId
                ? await axios.put(`/api/master/branches/${branchId}`, data)
                : await axios.post('/api/master/branches', data);

            Swal.close();

            if (response.data.success) {
                Swal.fire({ icon: 'success', title: 'Saved!', text: response.data.message || 'Branch saved', timer: 1800, showConfirmButton: false });
                closeModal();
                setTimeout(() => window.location.reload(), 900);
            } else {
                Swal.fire({ icon: 'error', title: 'Failed', text: response.data.message || 'Failed to save branch' });
            }

        } catch (error) {
            Swal.close();
            console.error('Error saving branch:', error);
            Swal.fire({ icon: 'error', title: 'Failed', text: error.response?.data?.message || 'Failed to save branch' });
        }
    });
</script>

</body>
</html>
