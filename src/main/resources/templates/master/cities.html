<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="fragments/head :: common-head('Cities')"></head>

<!-- SweetAlert2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<body class="bg-gray-50">
<!-- Navigation -->
<div th:replace="fragments/navigation :: navbar"></div>

<div class="container mx-auto px-4 py-8">
    <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-800">
            <i class="bi bi-geo-alt"></i> Cities Master
        </h2>
        <p class="text-gray-600">Manage city codes and descriptions</p>
    </div>
    <div id="react-root"></div>
</div>

<!-- Add/Edit Modal -->
<div id="cityModal" class="modal">
    <div class="modal-content">
        <div class="gradient-bg text-white p-6 rounded-t-xl">
            <h3 class="text-2xl font-bold" id="modalTitle"><i class="bi bi-plus-circle"></i> Add City</h3>
        </div>
        <div class="p-6">
            <form id="cityForm">
                <input type="hidden" id="cityId">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">City Code *</label>
                    <input type="text" id="cityCode" maxlength="20"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent uppercase"
                           placeholder="e.g., HYD" required>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">City Description *</label>
                    <input type="text" id="cityDesc" maxlength="200"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="e.g., Hyderabad" required>
                </div>
                <div class="flex space-x-3">
                    <button type="submit"
                            class="flex-1 gradient-bg text-white py-3 rounded-lg hover:opacity-90 transition font-semibold">
                        <i class="bi bi-save"></i> Save
                    </button>
                    <button type="button" onclick="closeModal()"
                            class="flex-1 bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-700 transition font-semibold">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- React + Babel + Axios -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- âœ… SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- JSX stored inside a JS string so Thymeleaf never parses it -->
<script th:inline="none">
    const CITIES_JSX = `
      const { useState, useEffect } = React;

      const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
      axios.defaults.headers.common[csrfHeader] = csrfToken;

      // SweetAlert helpers
      function toastSuccess(message){
        Swal.fire({ icon: 'success', title: 'Success', text: message, timer: 1700, showConfirmButton: false });
      }
      function toastError(message){
        Swal.fire({ icon: 'error', title: 'Error', text: message });
      }
      function showLoading(title='Please wait...'){
        Swal.fire({ title, allowOutsideClick:false, didOpen: () => Swal.showLoading() });
      }

      function CitiesManager() {
          const [cities, setCities] = useState([]);
          const [loading, setLoading] = useState(false);
          const [filter, setFilter] = useState('all');

          useEffect(() => { fetchCities(); }, []);

          const fetchCities = async () => {
              setLoading(true);
              try {
                  const response = await axios.get('/api/master/cities');
                  setCities(response.data);
              } catch (error) {
                  console.error('Error fetching cities:', error);
                  toastError('Failed to fetch cities');
              } finally {
                  setLoading(false);
              }
          };

          const openAddModal = () => {
              document.getElementById('cityId').value = '';
              document.getElementById('cityCode').value = '';
              document.getElementById('cityDesc').value = '';
              document.getElementById('cityCode').disabled = false;
              document.getElementById('modalTitle').innerHTML = '<i class="bi bi-plus-circle"></i> Add City';
              document.getElementById('cityModal').classList.add('show');
          };

          const openEditModal = (city) => {
              document.getElementById('cityId').value = city.id;
              document.getElementById('cityCode').value = city.cityCode;
              document.getElementById('cityDesc').value = city.cityDesc;
              document.getElementById('cityCode').disabled = true;
              document.getElementById('modalTitle').innerHTML = '<i class="bi bi-pencil-square"></i> Edit City';
              document.getElementById('cityModal').classList.add('show');
          };

          const toggleActive = async (id) => {
              const result = await Swal.fire({
                icon: 'question',
                title: 'Toggle Status?',
                text: 'Are you sure you want to change active/inactive?',
                showCancelButton: true,
                confirmButtonText: 'Yes, change',
                cancelButtonText: 'Cancel'
              });
              if (!result.isConfirmed) return;

              try {
                  showLoading('Updating status...');
                  const response = await axios.post(\`/api/master/cities/\${id}/toggle-active\`);
                  Swal.close();

                  if (response.data.success) {
                      toastSuccess(response.data.message || 'Status updated');
                      fetchCities();
                  } else {
                      toastError(response.data.message || 'Failed to toggle status');
                  }
              } catch (error) {
                  Swal.close();
                  console.error('Error toggling status:', error);
                  toastError('Failed to toggle status');
              }
          };

          const deleteCity = async (id) => {
              const result = await Swal.fire({
                icon: 'warning',
                title: 'Delete City?',
                text: 'This action cannot be undone.',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete',
                confirmButtonColor: '#d33',
                cancelButtonText: 'Cancel'
              });
              if (!result.isConfirmed) return;

              try {
                  showLoading('Deleting...');
                  const response = await axios.delete(\`/api/master/cities/\${id}\`);
                  Swal.close();

                  if (response.data.success) {
                      toastSuccess(response.data.message || 'City deleted');
                      fetchCities();
                  } else {
                      toastError(response.data.message || 'Failed to delete city');
                  }
              } catch (error) {
                  Swal.close();
                  console.error('Error deleting city:', error);
                  toastError('Failed to delete city');
              }
          };

          const handleExcelUpload = async (event) => {
              const file = event.target.files[0];
              if (!file) return;

              const formData = new FormData();
              formData.append('file', file);

              setLoading(true);
              try {
                  showLoading('Uploading file...');
                  const response = await axios.post('/api/master/cities/upload', formData, {
                      headers: { 'Content-Type': 'multipart/form-data' }
                  });
                  Swal.close();

                  if (response.data.success) {
                      toastSuccess(response.data.message || 'Upload successful');
                      fetchCities();
                  } else {
                      toastError(response.data.message || 'Upload failed');
                  }
              } catch (error) {
                  Swal.close();
                  console.error('Error uploading Excel:', error);
                  toastError(error.response?.data?.message || 'Failed to upload Excel');
              } finally {
                  setLoading(false);
                  event.target.value = '';
              }
          };

          const downloadTemplate = () => {
              const template = "City Code,City Description\\nHYD,Hyderabad\\nBLR,Bangalore\\nCHN,Chennai";
              const blob = new Blob([template], { type: 'text/csv' });
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'cities_template.csv';
              a.click();

              Swal.fire({ icon:'info', title:'Template Downloaded', text:'cities_template.csv downloaded.', timer:1500, showConfirmButton:false });
          };

          const filteredCities = cities.filter(city => {
              if (filter === 'active') return city.active;
              if (filter === 'inactive') return !city.active;
              return true;
          });

          window.openAddModal = openAddModal;
          window.openEditModal = openEditModal;
          window.toggleActive = toggleActive;
          window.deleteCity = deleteCity;

          if (loading) {
              return (
                  <div className="text-center py-12">
                      <div className="inline-block animate-spin rounded-full h-16 w-16 border-4 border-green-500 border-t-transparent"></div>
                      <p className="mt-4 text-gray-600">Loading...</p>
                  </div>
              );
          }

          return (
              <div>
                  <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                      <div className="flex flex-wrap items-center justify-between gap-4">
                          <div className="flex items-center space-x-2">
                              <button className="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition font-semibold" onClick={openAddModal}>
                                  <i className="bi bi-plus-circle"></i> Add City
                              </button>

                              <label className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-semibold cursor-pointer">
                                  <i className="bi bi-upload"></i> Upload Excel
                                  <input type="file" accept=".xlsx,.xls,.csv" onChange={handleExcelUpload} className="hidden" />
                              </label>

                              <button className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition font-semibold" onClick={downloadTemplate}>
                                  <i className="bi bi-download"></i> Template
                              </button>

                              <button className="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition font-semibold" onClick={fetchCities}>
                                  <i className="bi bi-arrow-clockwise"></i> Refresh
                              </button>
                          </div>

                          <div className="flex items-center space-x-2">
                              <label className="text-sm font-medium text-gray-700">Filter:</label>
                              <select
                                  className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                  value={filter}
                                  onChange={(e) => setFilter(e.target.value)}
                              >
                                  <option value="all">All ({cities.length})</option>
                                  <option value="active">Active ({cities.filter(c => c.active).length})</option>
                                  <option value="inactive">Inactive ({cities.filter(c => !c.active).length})</option>
                              </select>
                          </div>
                      </div>
                  </div>

                  <div className="bg-white rounded-xl shadow-md overflow-hidden">
                      <div className="overflow-x-auto">
                          <table className="w-full">
                              <thead className="gradient-bg text-white">
                                  <tr>
                                      <th className="px-4 py-3 text-left">#</th>
                                      <th className="px-4 py-3 text-left">City Code</th>
                                      <th className="px-4 py-3 text-left">City Description</th>
                                      <th className="px-4 py-3 text-left">Status</th>
                                      <th className="px-4 py-3 text-left">Created</th>
                                      <th className="px-4 py-3 text-left">Actions</th>
                                  </tr>
                              </thead>
                              <tbody className="divide-y divide-gray-200">
                                  {filteredCities.length === 0 ? (
                                      <tr>
                                          <td colSpan="6" className="px-4 py-12 text-center">
                                              <i className="bi bi-inbox text-6xl text-gray-300"></i>
                                              <p className="text-gray-500 mt-4 text-lg">No cities found</p>
                                          </td>
                                      </tr>
                                  ) : (
                                      filteredCities.map((city, index) => (
                                          <tr key={city.id} className="hover:bg-gray-50 transition">
                                              <td className="px-4 py-3">{index + 1}</td>
                                              <td className="px-4 py-3 font-bold text-green-600">{city.cityCode}</td>
                                              <td className="px-4 py-3">{city.cityDesc}</td>
                                              <td className="px-4 py-3">
                                                  <span className={\`px-3 py-1 rounded-full text-xs font-semibold \${city.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}\`}>
                                                      {city.active ? 'Active' : 'Inactive'}
                                                  </span>
                                              </td>
                                              <td className="px-4 py-3 text-sm text-gray-600">
                                                  {new Date(city.createdAt).toLocaleDateString()}
                                              </td>
                                              <td className="px-4 py-3">
                                                  <div className="flex space-x-2">
                                                      <button className="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 transition text-sm" onClick={() => openEditModal(city)} title="Edit">
                                                          <i className="bi bi-pencil"></i>
                                                      </button>

                                                      <button className={\`\${city.active ? 'bg-orange-600 hover:bg-orange-700' : 'bg-green-600 hover:bg-green-700'} text-white px-3 py-1 rounded-lg transition text-sm\`}
                                                              onClick={() => toggleActive(city.id)}
                                                              title={city.active ? 'Deactivate' : 'Activate'}>
                                                          <i className={\`bi bi-\${city.active ? 'toggle-on' : 'toggle-off'}\`}></i>
                                                      </button>

                                                      <button className="bg-red-600 text-white px-3 py-1 rounded-lg hover:bg-red-700 transition text-sm" onClick={() => deleteCity(city.id)} title="Delete">
                                                          <i className="bi bi-trash"></i>
                                                      </button>
                                                  </div>
                                              </td>
                                          </tr>
                                      ))
                                  )}
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
          );
      }

      const root = ReactDOM.createRoot(document.getElementById('react-root'));
      root.render(<CitiesManager />);
    `;

    (function () {
        const compiled = Babel.transform(CITIES_JSX, { presets: ['react'] }).code;
        new Function(compiled)();
    })();
</script>

<!-- Plain JS (no JSX) -->
<script>
    function closeModal() {
        document.getElementById('cityModal').classList.remove('show');
    }

    window.onclick = function(event) {
        const modal = document.getElementById('cityModal');
        if (event.target === modal) {
            closeModal();
        }
    }

    document.getElementById('cityForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const cityId = document.getElementById('cityId').value;
        const data = {
            cityCode: document.getElementById('cityCode').value.toUpperCase(),
            cityDesc: document.getElementById('cityDesc').value,
            active: true
        };

        try {
            Swal.fire({ title: 'Saving...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            const response = cityId
                ? await axios.put(`/api/master/cities/${cityId}`, data)
                : await axios.post('/api/master/cities', data);

            Swal.close();

            if (response.data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Saved!',
                    text: response.data.message || 'City saved',
                    timer: 1600,
                    showConfirmButton: false
                });
                closeModal();
                setTimeout(() => window.location.reload(), 900);
            } else {
                Swal.fire({ icon: 'error', title: 'Failed', text: response.data.message || 'Failed to save city' });
            }
        } catch (error) {
            Swal.close();
            console.error('Error saving city:', error);
            Swal.fire({ icon: 'error', title: 'Failed', text: error.response?.data?.message || 'Failed to save city' });
        }
    });
</script>

</body>
</html>
