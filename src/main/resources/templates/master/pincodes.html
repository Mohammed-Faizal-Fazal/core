<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="fragments/head :: common-head('Pincodes')"></head>

<!-- SweetAlert2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<body class="bg-gray-50">
<div th:replace="fragments/navigation :: navbar"></div>

<div class="container mx-auto px-4 py-8">
    <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-800">
            <i class="bi bi-pin-map"></i> Pincodes Master
        </h2>
        <p class="text-gray-600">Manage pincodes and city mappings</p>
    </div>
    <div id="react-root"></div>
</div>

<!-- Add/Edit Modal -->
<div id="pincodeModal" class="modal">
    <div class="modal-content">
        <div class="gradient-bg text-white p-6 rounded-t-xl">
            <h3 class="text-2xl font-bold" id="modalTitle">
                <i class="bi bi-plus-circle"></i> Add Pincode
            </h3>
        </div>
        <div class="p-6">
            <form id="pincodeForm">
                <input type="hidden" id="pincodeId">

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Pincode *</label>
                    <input type="text" id="pincode" maxlength="10"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                           placeholder="e.g., 500001" required>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">City Code *</label>
                    <input type="text" id="cityCode" maxlength="20"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 uppercase"
                           placeholder="e.g., HYD" required>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Area (Optional)</label>
                    <input type="text" id="area" maxlength="200"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                           placeholder="e.g., Banjara Hills">
                </div>

                <div class="flex space-x-3">
                    <button type="submit"
                            class="flex-1 gradient-bg text-white py-3 rounded-lg hover:opacity-90 transition font-semibold">
                        <i class="bi bi-save"></i> Save
                    </button>
                    <button type="button" onclick="closeModal()"
                            class="flex-1 bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-700 transition font-semibold">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- React + Babel + Axios -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script th:inline="none">
    const PINCODES_JSX = `
      const { useState, useEffect } = React;

      const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
      axios.defaults.headers.common[csrfHeader] = csrfToken;

      const toastSuccess = (msg) => Swal.fire({ icon:'success', title:'Success', text:msg, timer:1600, showConfirmButton:false });
      const toastError = (msg) => Swal.fire({ icon:'error', title:'Error', text:msg });
      const showLoading = (t='Please wait...') => Swal.fire({ title:t, allowOutsideClick:false, didOpen:()=>Swal.showLoading() });

      function PincodesManager(){
        const [pincodes,setPincodes]=useState([]);
        const [loading,setLoading]=useState(false);
        const [filter,setFilter]=useState('all');
        const [cityFilter,setCityFilter]=useState('');

        useEffect(()=>{ fetchPincodes(); },[]);

        const fetchPincodes = async ()=>{
          setLoading(true);
          try{
            const r = await axios.get('/api/master/pincodes');
            setPincodes(r.data);
          }catch{
            toastError('Failed to fetch pincodes');
          }finally{
            setLoading(false);
          }
        };

        const openAddModal=()=>{
          pincodeId.value=''; pincode.value=''; cityCode.value=''; area.value='';
          pincode.disabled=false;
          modalTitle.innerHTML='<i class="bi bi-plus-circle"></i> Add Pincode';
          pincodeModal.classList.add('show');
        };

        const openEditModal=(p)=>{
          pincodeId.value=p.id; pincode.value=p.pincode;
          cityCode.value=p.cityCode; area.value=p.area||'';
          pincode.disabled=true;
          modalTitle.innerHTML='<i class="bi bi-pencil-square"></i> Edit Pincode';
          pincodeModal.classList.add('show');
        };

        const toggleActive = async(id)=>{
          const r=await Swal.fire({icon:'question',title:'Toggle status?',showCancelButton:true});
          if(!r.isConfirmed) return;
          try{
            showLoading('Updating...');
            const res=await axios.post(\`/api/master/pincodes/\${id}/toggle-active\`);
            Swal.close();
            res.data.success ? toastSuccess(res.data.message) : toastError(res.data.message);
            fetchPincodes();
          }catch{
            Swal.close(); toastError('Failed to toggle status');
          }
        };

        const deletePincode = async(id)=>{
          const r=await Swal.fire({icon:'warning',title:'Delete pincode?',text:'This cannot be undone',showCancelButton:true,confirmButtonColor:'#d33'});
          if(!r.isConfirmed) return;
          try{
            showLoading('Deleting...');
            const res=await axios.delete(\`/api/master/pincodes/\${id}\`);
            Swal.close();
            res.data.success ? toastSuccess(res.data.message) : toastError(res.data.message);
            fetchPincodes();
          }catch{
            Swal.close(); toastError('Delete failed');
          }
        };

        const handleExcelUpload=async(e)=>{
          const f=e.target.files[0]; if(!f) return;
          const fd=new FormData(); fd.append('file',f);
          try{
            showLoading('Uploading...');
            const res=await axios.post('/api/master/pincodes/upload',fd);
            Swal.close();
            res.data.success ? toastSuccess(res.data.message) : toastError(res.data.message);
            fetchPincodes();
          }catch{
            Swal.close(); toastError('Upload failed');
          }finally{ e.target.value=''; }
        };

        const filtered = pincodes.filter(p=>{
          if(filter==='active' && !p.active) return false;
          if(filter==='inactive' && p.active) return false;
          if(cityFilter && !(p.cityCode||'').toLowerCase().includes(cityFilter.toLowerCase())) return false;
          return true;
        });

        window.openAddModal=openAddModal;
        window.openEditModal=openEditModal;
        window.toggleActive=toggleActive;
        window.deletePincode=deletePincode;

        if(loading){
          return <div className="text-center py-12">
            <div className="animate-spin h-16 w-16 border-4 border-green-500 border-t-transparent rounded-full mx-auto"></div>
          </div>;
        }

        return (
          <div>
            <div className="bg-white rounded-xl shadow-md p-6 mb-6 space-y-4">
              <div className="flex flex-wrap gap-2">
                <button className="gradient-bg text-white px-4 py-2 rounded-lg" onClick={openAddModal}>
                  <i className="bi bi-plus-circle"></i> Add Pincode
                </button>
                <label className="bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer">
                  <i className="bi bi-upload"></i> Upload
                  <input type="file" className="hidden" onChange={handleExcelUpload}/>
                </label>
              </div>

              <div className="flex flex-wrap gap-3">
                <select className="border px-3 py-2 rounded-lg" value={filter} onChange={e=>setFilter(e.target.value)}>
                  <option value="all">All</option>
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                </select>
                <input className="border px-3 py-2 rounded-lg" placeholder="Filter by city"
                       value={cityFilter} onChange={e=>setCityFilter(e.target.value)}/>
                <span className="text-sm text-gray-600">Showing {filtered.length} records</span>
              </div>
            </div>

            <div className="bg-white rounded-xl shadow overflow-x-auto">
              <table className="w-full">
                <thead className="gradient-bg text-white">
                  <tr>
                    <th className="px-4 py-3">#</th>
                    <th className="px-4 py-3">Pincode</th>
                    <th className="px-4 py-3">City</th>
                    <th className="px-4 py-3">Area</th>
                    <th className="px-4 py-3">Status</th>
                    <th className="px-4 py-3">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {filtered.map((p,i)=>(
                    <tr key={p.id} className="border-t">
                      <td className="px-4 py-2">{i+1}</td>
                      <td className="px-4 py-2 font-bold text-green-600">{p.pincode}</td>
                      <td className="px-4 py-2">{p.cityCode}</td>
                      <td className="px-4 py-2 text-sm">{p.area||'-'}</td>
                      <td className="px-4 py-2">
                        <span className={\`px-2 py-1 text-xs rounded \${p.active?'bg-green-100':'bg-red-100'}\`}>
                          {p.active?'Active':'Inactive'}
                        </span>
                      </td>
                      <td className="px-4 py-2 flex gap-2">
                        <button className="bg-blue-600 text-white px-2 rounded" onClick={()=>openEditModal(p)}>
                          <i className="bi bi-pencil"></i>
                        </button>
                        <button className="bg-orange-600 text-white px-2 rounded" onClick={()=>toggleActive(p.id)}>
                          <i className="bi bi-toggle-on"></i>
                        </button>
                        <button className="bg-red-600 text-white px-2 rounded" onClick={()=>deletePincode(p.id)}>
                          <i className="bi bi-trash"></i>
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('react-root')).render(<PincodesManager/>);
    `;
    (function(){
      const c=Babel.transform(PINCODES_JSX,{presets:['react']}).code;
      new Function(c)();
    })();
</script>

<script>
    function closeModal(){ pincodeModal.classList.remove('show'); }
    window.onclick=e=>{ if(e.target===pincodeModal) closeModal(); };

    document.getElementById('pincodeForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const id=pincodeId.value;
      const data={
        pincode:pincode.value,
        cityCode:cityCode.value.toUpperCase(),
        area:area.value||null,
        active:true
      };

      try{
        Swal.fire({title:'Saving...',allowOutsideClick:false,didOpen:()=>Swal.showLoading()});
        const r=id?await axios.put(`/api/master/pincodes/${id}`,data)
                   :await axios.post('/api/master/pincodes',data);
        Swal.close();
        if(r.data.success){
          Swal.fire({icon:'success',title:'Saved!',timer:1500,showConfirmButton:false});
          closeModal();
          setTimeout(()=>location.reload(),800);
        }else{
          Swal.fire({icon:'error',title:'Failed',text:r.data.message});
        }
      }catch{
        Swal.close();
        Swal.fire({icon:'error',title:'Failed',text:'Error saving pincode'});
      }
    });
</script>
</body>
</html>
